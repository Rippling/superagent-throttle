<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "lib/index.js";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h2">
        <a href="#default-options">default options</a>
      </div>

      <div class="heading h2">
        <a href="#throttle">Throttle</a>
      </div>

      <div class="heading h2">
        <a href="#_options">_options</a>
      </div>

      <div class="heading h2">
        <a href="#_initacrosstabs">_initAcrossTabs</a>
      </div>

      <div class="heading h2">
        <a href="#options">options</a>
      </div>

      <div class="heading h2">
        <a href="#setcurrent">setCurrent</a>
      </div>

      <div class="heading h2">
        <a href="#getcurrent">getCurrent</a>
      </div>

      <div class="heading h2">
        <a href="#next">next</a>
      </div>

      <div class="heading h2">
        <a href="#serial">serial</a>
      </div>

      <div class="heading h2">
        <a href="#_isratebound">_isRateBound</a>
      </div>

      <div class="heading h2">
        <a href="#cycle">cycle</a>
      </div>

      <div class="heading h2">
        <a href="#send">send</a>
      </div>

      <div class="heading h2">
        <a href="#plugin">plugin</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>index.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">import</span> EventEmitter <span class="hljs-keyword">from</span> <span class="hljs-string">'events'</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="default-options">
  <h2>
    <a href="#default-options" name="default-options" class="pilcrow"></a>
default options
  </h2>
</div>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">let</span> defaults = {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>start unpaused ?</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  active: <span class="hljs-literal">true</span>,
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>requests per <code>ratePer</code> ms</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  rate: <span class="hljs-number">40</span>,
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>ms per <code>rate</code> requests</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  ratePer: <span class="hljs-number">40000</span>,
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>max concurrent requests</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  concurrent: <span class="hljs-number">20</span>,
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>Enable/Disable cross-tab concurrency</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  acrossTabs: <span class="hljs-literal">false</span>,
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>Will be used while storing data in localStorage</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  tabIdPrefix: <span class="hljs-string">'_tab'</span>,
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>If <code>recentActionAt</code> is <code>tabExpire</code> ms old, assume it's dead. So ignore it's concurrency</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  tabExpire: <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="throttle">
  <h2>
    <a href="#throttle" name="throttle" class="pilcrow"></a>
Throttle
  </h2>
</div>
<p>The throttle object.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">options</span>
<span class="dox_type">object</span>
<span><ul>
<li>key value options</li>
</ul>
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Throttle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">EventEmitter</span> </span>{
  <span class="hljs-keyword">constructor</span> (options) {
    <span class="hljs-keyword">super</span>()
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>instance properties</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">this</span>._options({
      <span class="hljs-attr">_requestTimes</span>: [<span class="hljs-number">0</span>],
      <span class="hljs-attr">_buffer</span>: [],
      <span class="hljs-attr">_serials</span>: {},
      <span class="hljs-attr">_timeout</span>: <span class="hljs-literal">false</span>
    })
    <span class="hljs-keyword">this</span>._options(defaults)
    <span class="hljs-keyword">this</span>._options(options)

    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isLocalStorageEnabled()) {
      <span class="hljs-keyword">this</span>._options({ <span class="hljs-attr">acrossTabs</span>: <span class="hljs-literal">false</span> })
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>._initAcrossTabs()
    }
  }

  isLocalStorageEnabled () {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span> !== <span class="hljs-string">'undefined'</span>) {
        <span class="hljs-keyword">return</span> !!<span class="hljs-built_in">window</span>.localStorage
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="_options">
  <h2>
    <a href="#_options" name="_options" class="pilcrow"></a>
_options
  </h2>
</div>
<p>updates options on instance</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">options</span>
<span class="dox_type">Object</span>
<span><ul>
<li>key value object</li>
</ul>
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  _options (options) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> property <span class="hljs-keyword">in</span> options) {
      <span class="hljs-keyword">if</span> (options.hasOwnProperty(property)) {
        <span class="hljs-keyword">this</span>[property] = options[property]
      }
    }
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="_initacrosstabs">
  <h2>
    <a href="#_initacrosstabs" name="_initacrosstabs" class="pilcrow"></a>
_initAcrossTabs
  </h2>
</div>
<p>Setup cross-tab concurrency feature</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  _initAcrossTabs () {
    <span class="hljs-keyword">this</span>._tabId = <span class="hljs-keyword">this</span>.tabIdPrefix + <span class="hljs-string">'.'</span> + <span class="hljs-built_in">Date</span>.now();
    <span class="hljs-keyword">this</span>.setCurrent(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">this</span>.clearOld();
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onUnload</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-built_in">window</span>.localStorage.removeItem(<span class="hljs-keyword">this</span>._tabId)
    }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>clear localStorage</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">'unload'</span>, onUnload.bind(<span class="hljs-keyword">this</span>))
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="options">
  <h2>
    <a href="#options" name="options" class="pilcrow"></a>
options
  </h2>
</div>
<p>thin wrapper for _options</p>
</div>
<div class="body">
<ul>
<li>calls <code>this.cycle()</code></li>
<li>adds alternate syntax</li>
</ul>
<p>alternate syntax:
throttle.options('active', true)
throttle.options({active: true})</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">options</span>
<span class="dox_type">Object</span>
<span><ul>
<li>either key value object or keyname</li>
</ul>
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">[value]</span>
<span class="dox_type">Mixed</span>
<span><ul>
<li>value for key</li>
</ul>
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  options (options, value) {
    <span class="hljs-keyword">if</span> (
      (<span class="hljs-keyword">typeof</span> options === <span class="hljs-string">'string'</span>) &amp;&amp;
      (value)
    ) {
      options = { <span class="hljs-attr">options</span>: value }
    }
    <span class="hljs-keyword">this</span>._options(options)
    <span class="hljs-keyword">this</span>.cycle()
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="setcurrent">
  <h2>
    <a href="#setcurrent" name="setcurrent" class="pilcrow"></a>
setCurrent
  </h2>
</div>
<p>Sets concurrency count in localStorage</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">current</span>
<span class="dox_type">Number</span>
<span>concurrency count
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  setCurrent (current) {
    <span class="hljs-keyword">const</span> value = {
      <span class="hljs-attr">current</span>: current,
      <span class="hljs-attr">recentActionAt</span>: <span class="hljs-built_in">Date</span>.now() <span class="hljs-comment">// Always update action timestamp</span>
    }
    <span class="hljs-built_in">window</span>.localStorage.setItem(<span class="hljs-keyword">this</span>._tabId, <span class="hljs-built_in">JSON</span>.stringify(value))
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<div class="dox">
<div class="summary">
<p>clear Tab Data older than 7 days</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
  clearOld () {
    <span class="hljs-keyword">const</span> days = <span class="hljs-number">0.007</span> ; <span class="hljs-comment">// Days you want to subtract</span>
    <span class="hljs-keyword">const</span> referenceTime = (<span class="hljs-built_in">Date</span>.now() - (days * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>));
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> <span class="hljs-built_in">window</span>.localStorage) {
      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.hasOwnProperty.call(<span class="hljs-built_in">window</span>.localStorage, key) &amp;&amp; key.indexOf(<span class="hljs-keyword">this</span>.tabIdPrefix) === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">let</span> tabData = <span class="hljs-built_in">window</span>.localStorage.getItem(key);
        <span class="hljs-keyword">const</span> tabDate = <span class="hljs-built_in">Number</span>(key.split(<span class="hljs-string">'.'</span>)[<span class="hljs-number">1</span>]);
        <span class="hljs-keyword">if</span>(tabDate &lt; referenceTime) {
          <span class="hljs-built_in">window</span>.localStorage.removeItem(key)
        }
      }
    }
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="getcurrent">
  <h2>
    <a href="#getcurrent" name="getcurrent" class="pilcrow"></a>
getCurrent
  </h2>
</div>
<p>Computes current concurrency level</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  getCurrent () {
    <span class="hljs-keyword">let</span> current = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> <span class="hljs-built_in">window</span>.localStorage) {
      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.hasOwnProperty.call(<span class="hljs-built_in">window</span>.localStorage, key) &amp;&amp; key.indexOf(<span class="hljs-keyword">this</span>.tabIdPrefix) === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">let</span> tabData = <span class="hljs-built_in">window</span>.localStorage.getItem(key)

        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">if</span> (!tabData) {
            <span class="hljs-built_in">console</span>.assert(<span class="hljs-literal">false</span>, <span class="hljs-string">'tabData structure mis-matched: '</span> + <span class="hljs-built_in">JSON</span>.stringify(tabData))
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'catch me'</span>)
          }
          tabData = <span class="hljs-built_in">JSON</span>.parse(tabData)
        } <span class="hljs-keyword">catch</span> (ex) {
          <span class="hljs-keyword">continue</span>
        }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>Check whether other tabs are dead or not. If dead, ignore their concurrency count</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (key !== <span class="hljs-keyword">this</span>._tabId &amp;&amp; tabData.recentActionAt &lt; <span class="hljs-built_in">Date</span>.now() - <span class="hljs-keyword">this</span>.tabExpire) {
          <span class="hljs-keyword">continue</span>
        }
        current += tabData.current
      }
    }
    <span class="hljs-keyword">return</span> current
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<div class="dox">
<div class="summary">
<p>Updates current tab concurrency by adding/substracting the current count</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">value</span>
<span class="dox_type">Number</span>
<span><ul>
<li>Negative/Positive number</li>
</ul>
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  addAndSetCurrent (value) {
    <span class="hljs-keyword">let</span> tabData = <span class="hljs-built_in">window</span>.localStorage.getItem(<span class="hljs-keyword">this</span>._tabId)
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>If tabData is null/undefined, It means the tab is about to unload/close.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (tabData === <span class="hljs-literal">null</span> || tabData === <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
    }
    tabData = <span class="hljs-built_in">JSON</span>.parse(tabData)
    <span class="hljs-keyword">const</span> current = tabData.current
    <span class="hljs-keyword">this</span>.setCurrent(current + value)
    <span class="hljs-keyword">return</span> current + value
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="next">
  <h2>
    <a href="#next" name="next" class="pilcrow"></a>
next
  </h2>
</div>
<p>checks whether instance has available capacity and calls throttle.send()</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  next () {
    <span class="hljs-keyword">let</span> throttle = <span class="hljs-keyword">this</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>make requestTimes <code>throttle.rate</code> long. Oldest request will be 0th index</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    throttle._requestTimes =
      throttle._requestTimes.slice(throttle.rate * <span class="hljs-number">-1</span>)

    <span class="hljs-keyword">if</span> (
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>paused</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      !(throttle.active) ||
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>at concurrency limit</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      (throttle.getCurrent() &gt;= throttle.concurrent) ||
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>less than <code>ratePer</code></p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      throttle._isRateBound() ||
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>something waiting in the throttle</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      !(throttle._buffer.length)
    ) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    <span class="hljs-keyword">let</span> idx = throttle._buffer.findIndex(<span class="hljs-function">(<span class="hljs-params">request</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> !request.serial || !throttle._serials[request.serial]
    })
    <span class="hljs-keyword">if</span> (idx === <span class="hljs-number">-1</span>) {
      throttle._isSerialBound = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    throttle.send(throttle._buffer.splice(idx, <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>])
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="serial">
  <h2>
    <a href="#serial" name="serial" class="pilcrow"></a>
serial
  </h2>
</div>
<p>updates throttle._serials and throttle._isRateBound</p>
</div>
<div class="body">
<p>serial subthrottles allow some requests to be serialised, whilst maintaining
their place in the queue. The _serials structure keeps track of what serial
queues are waiting for a response.</p>
<pre><code>throttle._serials = {
  'example.com/end/point': true,
  'example.com/another': false
}
</code></pre>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">request</span>
<span class="dox_type">Request</span>
<span>superagent request
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">state</span>
<span class="dox_type">Boolean</span>
<span>new state for serial
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  serial (request, state) {
    <span class="hljs-keyword">let</span> serials = <span class="hljs-keyword">this</span>._serials
    <span class="hljs-keyword">let</span> throttle = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">if</span> (request.serial === <span class="hljs-literal">false</span>) {
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">if</span> (state === <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">return</span> serials[request.serial]
    }
    <span class="hljs-keyword">if</span> (state === <span class="hljs-literal">false</span>) {
      throttle._isSerialBound = <span class="hljs-literal">false</span>
    }
    serials[request.serial] = state
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="_isratebound">
  <h2>
    <a href="#_isratebound" name="_isratebound" class="pilcrow"></a>
_isRateBound
  </h2>
</div>
<p>returns true if throttle is bound by rate</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  _isRateBound () {
    <span class="hljs-keyword">let</span> throttle = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">return</span> (
      ((<span class="hljs-built_in">Date</span>.now() - throttle._requestTimes[<span class="hljs-number">0</span>]) &lt; throttle.ratePer) &amp;&amp;
      (throttle._buffer.length &gt; <span class="hljs-number">0</span>)
    )
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="cycle">
  <h2>
    <a href="#cycle" name="cycle" class="pilcrow"></a>
cycle
  </h2>
</div>
<p>an iterator of sorts. Should be called when</p>
</div>
<div class="body">
<ul>
<li>something added to throttle (check if it can be sent immediately)</li>
<li><code>ratePer</code> ms have elapsed since nth last call where n is <code>rate</code> (may have
available rate)</li>
<li>some request has ended (may have available concurrency)</li>
</ul>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">request</span>
<span class="dox_type">Request</span>
<span>the superagent request
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  cycle (request) {
    <span class="hljs-keyword">let</span> throttle = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">if</span> (request) {
      throttle._buffer.push(request)
    }
    clearTimeout(throttle._timeout)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>fire requests
throttle.next will return false if there's no capacity or throttle is
drained</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">while</span> (throttle.next()) {}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>if bound by rate, set timeout to reassess later.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (throttle._isRateBound()) {
      <span class="hljs-keyword">let</span> timeout
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<p>defined rate</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      timeout = throttle.ratePer
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<p>less ms elapsed since oldest request</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      timeout -= (<span class="hljs-built_in">Date</span>.now() - throttle._requestTimes[<span class="hljs-number">0</span>])
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35"></a>
</div>
<p>plus 1 ms to ensure you don't fire a request exactly ratePer ms later</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      timeout += <span class="hljs-number">1</span>
      throttle._timeout = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        throttle.cycle()
      }, timeout)
    }
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="send">
  <h2>
    <a href="#send" name="send" class="pilcrow"></a>
send
  </h2>
</div>
</div>
<div class="body">
<p>sends a queued request.</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">request</span>
<span class="dox_type">Request</span>
<span>superagent request
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  send (request) {
    <span class="hljs-keyword">let</span> throttle = <span class="hljs-keyword">this</span>
    throttle.serial(request, <span class="hljs-literal">true</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37"></a>
</div>
<p>declare callback within this enclosure, for access to throttle &amp; request</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cleanup</span> (<span class="hljs-params">err, response</span>) </span>{
      throttle.addAndSetCurrent(<span class="hljs-number">-1</span>)
      <span class="hljs-keyword">if</span> (err &amp;&amp; EventEmitter.listenerCount(throttle, <span class="hljs-string">'error'</span>)) {
        throttle.emit(<span class="hljs-string">'error'</span>, response)
      }
      throttle.emit(<span class="hljs-string">'received'</span>, request)

      <span class="hljs-keyword">if</span> (
        (!throttle._buffer.length) &amp;&amp;
        (!throttle.getCurrent())
      ) {
        throttle.emit(<span class="hljs-string">'drained'</span>)
      }
      throttle.serial(request, <span class="hljs-literal">false</span>)
      throttle.cycle()
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38"></a>
</div>
<p>original <code>callback</code> was stored at <code>request._maskedCallback</code></p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      request._maskedCallback(err, response)
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39"></a>
</div>
<p>original <code>request.end</code> was stored at <code>request._maskedEnd</code></p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    request._maskedEnd(cleanup)
    throttle._requestTimes.push(<span class="hljs-built_in">Date</span>.now())
    throttle.addAndSetCurrent(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'sent'</span>, request)
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="plugin">
  <h2>
    <a href="#plugin" name="plugin" class="pilcrow"></a>
plugin
  </h2>
</div>
</div>
<div class="body">
<p><code>superagent</code> <code>use</code> function should refer to this plugin method a la
<code>.use(throttle.plugin())</code></p>
<p>mask the original <code>.end</code> and store the callback passed in</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">serial</span>
<span class="dox_type">string</span>
<span>any string is ok, it's just a namespace
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  plugin (serial) {
    <span class="hljs-keyword">let</span> throttle = <span class="hljs-keyword">this</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41"></a>
</div>
<p>let patch = function(request) {</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">request</span>) =&gt;</span> {
      request.throttle = throttle
      request.serial = serial || <span class="hljs-literal">false</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42"></a>
</div>
<p>replace request.end</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      request._maskedEnd = request.end
      request.end = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">callback</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43"></a>
</div>
<p>store callback as superagent does</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        request._maskedCallback = callback || <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{}
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44"></a>
</div>
<p>place this request in the queue</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        request.throttle.cycle(request)
        <span class="hljs-keyword">return</span> request
      }
      <span class="hljs-keyword">return</span> request
    }
  }
}

<span class="hljs-built_in">module</span>.exports = Throttle

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
