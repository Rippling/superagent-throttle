<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "test/index.js";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h2">
        <a href="#log">log</a>
      </div>

      <div class="heading h2">
        <a href="#max">max</a>
      </div>

      <div class="heading h2">
        <a href="#it-should-allow-serialised-queues">it should allow serialised queues</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>index.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">import</span> Throttle <span class="hljs-keyword">from</span> <span class="hljs-string">'../lib/index'</span>
<span class="hljs-keyword">import</span> nock <span class="hljs-keyword">from</span> <span class="hljs-string">'nock'</span>
<span class="hljs-keyword">import</span> { assert } <span class="hljs-keyword">from</span> <span class="hljs-string">'chai'</span>
<span class="hljs-keyword">import</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">'superagent'</span>
<span class="hljs-keyword">import</span> _ <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>

nock(<span class="hljs-string">'http://stub'</span>)
.get(<span class="hljs-string">'/time'</span>)
.times(<span class="hljs-number">1000</span>)
.reply(<span class="hljs-number">201</span>, () =&gt; <span class="hljs-built_in">Date</span>.now())

nock(<span class="hljs-string">'http://stub'</span>)
.get(<span class="hljs-string">'/delay'</span>)
.socketDelay(<span class="hljs-number">2000</span>)
.times(<span class="hljs-number">1000</span>)
.reply(<span class="hljs-number">200</span>, <span class="hljs-string">'&lt;html&gt;&lt;/html&gt;'</span>)
nock.disableNetConnect()

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="log">
  <h2>
    <a href="#log" name="log" class="pilcrow"></a>
log
  </h2>
</div>
</div>
<div class="body">
<p>a helper to write pretty tables when attached to Throttle events</p>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span> (<span class="hljs-params">prefix</span>) </span>{
  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>
  <span class="hljs-keyword">let</span> start = <span class="hljs-built_in">Date</span>.now()
  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">request</span>) =&gt;</span> {
    <span class="hljs-keyword">let</span> rate
    <span class="hljs-keyword">let</span> check = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-built_in">Date</span>.now() - request.throttle.ratePer)
    rate = request.throttle._requestTimes.length - <span class="hljs-number">1</span> - _.findLastIndex(
      request.throttle._requestTimes,
      (date) =&gt; (date &lt; check)
    )
    count += <span class="hljs-number">1</span>
    <span class="hljs-built_in">console</span>.log([
      <span class="hljs-string">'| '</span>,
      _.padEnd(prefix, <span class="hljs-number">10</span>, <span class="hljs-string">' '</span>),
      <span class="hljs-string">'| '</span>,
      _.padStart(count, <span class="hljs-number">3</span>, <span class="hljs-string">' '</span>),
      <span class="hljs-string">' | '</span>,
      _.padStart(<span class="hljs-built_in">Date</span>.now() - start, <span class="hljs-number">6</span>, <span class="hljs-string">' '</span>),
      <span class="hljs-string">' | conc: '</span>,
      _.padStart(request.throttle._current, <span class="hljs-number">3</span>, <span class="hljs-string">' '</span>),
      <span class="hljs-string">' | rate: '</span>,
      _.padStart(rate, <span class="hljs-number">3</span>, <span class="hljs-string">' '</span>),
      <span class="hljs-string">' | queued: '</span>,
      _.padStart(request.throttle._buffer.length, <span class="hljs-number">3</span>, <span class="hljs-string">' '</span>),
      <span class="hljs-string">' | '</span>,
      request.serial
    ].join(<span class="hljs-string">''</span>))
  }
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="max">
  <h2>
    <a href="#max" name="max" class="pilcrow"></a>
max
  </h2>
</div>
</div>
<div class="body">
<p>collates various maximums, useful for tests</p>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">max</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>
  <span class="hljs-keyword">let</span> maxRate = <span class="hljs-number">0</span>
  <span class="hljs-keyword">let</span> maxConcurrent = <span class="hljs-number">0</span>
  <span class="hljs-keyword">let</span> maxBuffer = <span class="hljs-number">0</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">request</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (request) {
      <span class="hljs-keyword">let</span> rate
      <span class="hljs-keyword">let</span> check = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-built_in">Date</span>.now() - request.throttle.ratePer)
      rate = request.throttle._requestTimes.length - <span class="hljs-number">1</span> - _.findLastIndex(
        request.throttle._requestTimes,
        (date) =&gt; (date &lt; check)
      )
      count += <span class="hljs-number">1</span>
      <span class="hljs-keyword">if</span> (maxConcurrent &lt; request.throttle._current) {
        maxConcurrent = request.throttle._current
      }
      <span class="hljs-keyword">if</span> (maxRate &lt; rate) {
        maxRate = rate
      }
      <span class="hljs-keyword">if</span> (maxBuffer &lt; request.throttle._buffer.length) {
        maxBuffer = request.throttle._buffer.length
      }
    }
    <span class="hljs-keyword">return</span> {
      count,
      maxRate,
      maxConcurrent,
      maxBuffer
    }
  }
}

describe(<span class="hljs-string">'throttle'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">this</span>.timeout(<span class="hljs-number">15000</span>)
  it(<span class="hljs-string">'should clear errored requests (issue #6)'</span>, (done) =&gt; {
    <span class="hljs-keyword">let</span> throttle = <span class="hljs-keyword">new</span> Throttle()

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p><code>stub/delay</code> will return after 2000ms</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    request
    .get(<span class="hljs-string">'http://stub/delay'</span>)
    .timeout(<span class="hljs-number">1000</span>)
    .use(throttle.plugin())
    .end(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (err) <span class="hljs-built_in">console</span>.log(err)
      <span class="hljs-built_in">console</span>.log(throttle._current)
      assert(throttle._current === <span class="hljs-number">0</span>, <span class="hljs-string">'request has not been cleared'</span>)
      done()
    })
  })

  it(<span class="hljs-string">'should work with low concurrency'</span>, (done) =&gt; {
    <span class="hljs-keyword">let</span> highest = max()
    <span class="hljs-keyword">let</span> throttle = <span class="hljs-keyword">new</span> Throttle({
      <span class="hljs-attr">active</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">rate</span>: <span class="hljs-number">1000</span>,
      <span class="hljs-attr">ratePer</span>: <span class="hljs-number">2000</span>,
      <span class="hljs-attr">concurrent</span>: <span class="hljs-number">2</span>
    })
    throttle.on(<span class="hljs-string">'sent'</span>, highest)
    throttle.on(<span class="hljs-string">'received'</span>, highest)

    _.times(<span class="hljs-number">10</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">idx</span>) </span>{
      request
      .get(<span class="hljs-string">'stub/time'</span>)
      .use(throttle.plugin())
      .end()
    })

    throttle.on(<span class="hljs-string">'drained'</span>, () =&gt; {
      <span class="hljs-keyword">let</span> result = highest()
      assert(result.maxConcurrent === <span class="hljs-number">2</span>, <span class="hljs-string">'highest concurrency was 2'</span>)
      done()
    })
  })

  it(<span class="hljs-string">'should work with low rate'</span>, (done) =&gt; {
    <span class="hljs-keyword">let</span> highest = max()
    <span class="hljs-keyword">let</span> throttle = <span class="hljs-keyword">new</span> Throttle({
      <span class="hljs-attr">active</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">rate</span>: <span class="hljs-number">2</span>,
      <span class="hljs-attr">ratePer</span>: <span class="hljs-number">1000</span>,
      <span class="hljs-attr">concurrent</span>: <span class="hljs-number">2</span>
    })
    throttle.on(<span class="hljs-string">'sent'</span>, highest)
    throttle.on(<span class="hljs-string">'received'</span>, highest)
    throttle.on(<span class="hljs-string">'sent'</span>, log(<span class="hljs-string">'sent'</span>))
    throttle.on(<span class="hljs-string">'received'</span>, log(<span class="hljs-string">'rcvd'</span>))

    _.times(<span class="hljs-number">10</span>, (idx) =&gt; {
      request
      .get(<span class="hljs-string">'stub/time'</span>)
      .use(throttle.plugin())
      .end()
    })

    throttle.on(<span class="hljs-string">'drained'</span>, () =&gt; {
      <span class="hljs-keyword">let</span> result = highest()
      assert(result.maxRate === <span class="hljs-number">2</span>, <span class="hljs-string">'highest rate was 2'</span>)
      done()
    })
  })

  it(<span class="hljs-string">'should work when resource bound (issue #6)'</span>, (done) =&gt; {
    <span class="hljs-keyword">let</span> highest = max()
    <span class="hljs-keyword">let</span> throttle = <span class="hljs-keyword">new</span> Throttle({
      <span class="hljs-attr">active</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">rate</span>: <span class="hljs-number">1000</span>,
      <span class="hljs-attr">ratePer</span>: <span class="hljs-number">5000</span>,
      <span class="hljs-attr">concurrent</span>: <span class="hljs-number">1000</span>
    })
    throttle.on(<span class="hljs-string">'sent'</span>, highest)
    throttle.on(<span class="hljs-string">'received'</span>, highest)
    throttle.on(<span class="hljs-string">'sent'</span>, log(<span class="hljs-string">'sent'</span>))
    throttle.on(<span class="hljs-string">'received'</span>, log(<span class="hljs-string">'rcvd'</span>))

    _.times(<span class="hljs-number">500</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">idx</span>) </span>{
      request
      .get(<span class="hljs-string">'stub/time'</span>)
      .use(throttle.plugin())
      .end()
    })

    throttle.on(<span class="hljs-string">'drained'</span>, () =&gt; {
      assert.isOk(<span class="hljs-literal">true</span>, <span class="hljs-string">'has thrown error?'</span>)
      done()
    })
  })

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="it-should-allow-serialised-queues">
  <h2>
    <a href="#it-should-allow-serialised-queues" name="it-should-allow-serialised-queues" class="pilcrow"></a>
it should allow serialised queues
  </h2>
</div>
</div>
<div class="body">
<p>this test is pretty ugly, but I can't think of a better way for the time
being. Basically there's an array of serial identifiers, which are attached
to requests, then as they come back those identifiers are stored, and teh
test is passed if no serialised requests come back consecutively.</p>
<p>a better test would ensure that no two serial requests for the same uri
are requested simultaneously. But for now this will do.</p>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  it(<span class="hljs-string">'should allow serialised queues'</span>, (done) =&gt; {
    <span class="hljs-keyword">let</span> throttle = <span class="hljs-keyword">new</span> Throttle({
      <span class="hljs-attr">active</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">rate</span>: <span class="hljs-number">10</span>,
      <span class="hljs-attr">ratePer</span>: <span class="hljs-number">5000</span>,
      <span class="hljs-attr">concurrent</span>: <span class="hljs-number">2</span>
    })
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>throttle.on('sent', log('sent'))
throttle.on('received', log('rcvd'))</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    <span class="hljs-keyword">let</span> uris = [
      <span class="hljs-literal">undefined</span>,
      <span class="hljs-string">'someUri'</span>,
      <span class="hljs-string">'someUri'</span>,
      <span class="hljs-string">'someUri'</span>,
      <span class="hljs-literal">undefined</span>,
      <span class="hljs-literal">undefined</span>,
      <span class="hljs-literal">undefined</span>,
      <span class="hljs-literal">undefined</span>
    ]
    <span class="hljs-keyword">let</span> responses = []

    _.each(uris, (uri) =&gt; {
      request.get(<span class="hljs-string">'http://stub/time'</span>)
      .use(throttle.plugin(uri))
      .end(<span class="hljs-function">(<span class="hljs-params">err, res</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (err) <span class="hljs-built_in">console</span>.log(err)
        <span class="hljs-keyword">else</span> responses.push(request.serial)
      })
    })

    throttle.on(<span class="hljs-string">'drained'</span>, () =&gt; {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>responses should not have two consecutive 'someUri'</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">let</span> consecutive = _.some(responses, (response, idx) =&gt; {
        <span class="hljs-keyword">if</span> (idx === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>
        <span class="hljs-keyword">if</span> (
          (responses[idx - <span class="hljs-number">1</span>] === <span class="hljs-string">'someUri'</span>) &amp;&amp;
          (responses[idx] === <span class="hljs-string">'someUri'</span>)
        ) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
      })
      assert.isOk(!consecutive, <span class="hljs-string">'requests have not been serialised'</span>)
      done()
    })
  })

  it(<span class="hljs-string">'should not break end handler (issue #5)'</span>, (done) =&gt; {
    <span class="hljs-keyword">let</span> throttle = <span class="hljs-keyword">new</span> Throttle()

    request
    .get(<span class="hljs-string">'stub/time'</span>)
    .use(throttle.plugin())
    .end(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      assert.isOk(<span class="hljs-literal">true</span>, <span class="hljs-string">'end handler not working?'</span>)
      done()
    })
  })

  it(<span class="hljs-string">'should return superagent instance (issue #2)'</span>, () =&gt; {
    <span class="hljs-keyword">let</span> throttle = <span class="hljs-keyword">new</span> Throttle()

    <span class="hljs-keyword">let</span> instance = request.get(<span class="hljs-string">'stub/time'</span>)
    <span class="hljs-keyword">let</span> returned = instance.use(throttle.plugin())
    assert(instance === returned, <span class="hljs-string">'instance not returned'</span>)
  })
})

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
